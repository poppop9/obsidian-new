https://www.youtube.com/watch?v=CvDS6DltIno&list=PL41m5U3u3wwkS8BU0fIeRQwY3hK4VlFlX&index=2&t=13s

> [!quote] JPA 
> JPA ã€~~Java Persistence API~~ã€‘æ˜¯ä¸€ç§è§„èŒƒï¼Œå¯ä»¥çœ‹ä½œæ˜¯ JDBC çš„å‡çº§ç‰ˆã€‚JPA å°è£…äº† Hibernateï¼ŒHibernate é€šè¿‡ ORM å°† Java å¯¹è±¡æ˜ å°„åˆ°è¡¨ï¼Œå†é€šè¿‡ SQL æ¥æ“ä½œè¡¨

```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
```

# â¤ é…ç½®æ–‡ä»¶
- `hibernate` 
	- `ddl-auto` 
		- none ä¸åšä»»ä½•æ“ä½œ
		- validate æ£€æŸ¥æ•°æ®åº“ç»“æ„æ˜¯å¦ä¸å®ä½“ç±»ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œ~~ShardingSphere ä½¿ç”¨~~
		- create åº”ç”¨å¯åŠ¨ä¼šé‡æ–°åˆ›å»ºè¡¨
		- create-drop åº”ç”¨å¯åŠ¨ä¼šé‡æ–°åˆ›å»ºè¡¨ï¼›åœ¨åº”ç”¨åœæ­¢æ—¶ï¼Œåˆ é™¤è¡¨
		- update 
```yml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/spring-data
    username: root
    password: 13433026660
  jpa:
    open-in-view: false  # é¿å…å†…å­˜æ³„æ¼
    hibernate:
      ddl-auto: update  # è‡ªåŠ¨æ£€æµ‹å®ä½“ç±»çš„å˜åŒ–ï¼Œæ›´æ–°æ•°æ®åº“è¡¨
      show-sql: true  # åœ¨æ§åˆ¶å°æ˜¾ç¤ºsqlè¯­å¥
      properties:
        hibernate:
          format_sql: true  # æ ¼å¼åŒ–sqlè¯­å¥
	  naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl  # ç”Ÿæˆçš„è¡¨åä¸å®ä½“åç›¸åŒ
#    database: postgresql  # æŒ‡å®šæ•°æ®åº“
#    database-platform: org.hibernate.dialect.PostgreSQLDialect  # æŒ‡å®šæ•°æ®åº“æ–¹è¨€
```

# â¤ Entity
## ğŸ’› å®ä½“ç±»æ³¨è§£
- `@Entity` æ ‡è®°ä¸ºå®ä½“
- `@Table` é…ç½®è¡¨
	- `name` æŒ‡å®šè¡¨å
	- `indexes` æŒ‡å®šç´¢å¼•
		- `@Index` 
			- columnList
			- unique
				- true åˆ›å»ºå”¯ä¸€çº¦æŸï¼Œä¸æ™®é€šç´¢å¼•åœ¨æŸ¥è¯¢æ—¶æ²¡æœ‰æ€§èƒ½å·®å¼‚ï¼Œä½†æ˜¯åœ¨å†™æ“ä½œæ—¶ç”±äºéœ€è¦æ£€æŸ¥ï¼Œæ‰€ä»¥ä¼šæ¯”æ™®é€šç´¢å¼•æ…¢ä¸€ç‚¹
				- boolean ~~é»˜è®¤~~
- `@Comment` æ³¨é‡Šï¼ˆå°†å±•ç¤ºåœ¨æ•°æ®åº“ä¸­ï¼‰

```java
@Table(name = "Award",indexes = {  
		@Index(columnList = "awardKey"),  
		@Index(columnList = "awardConfig"),  
        // å¤åˆç´¢å¼•ï¼Œå½“æŸ¥è¯¢æ¡ä»¶åŒæ—¶æœ‰è¿™ä¸¤ä¸ªå€¼æ—¶ï¼Œé€Ÿåº¦æ¯”å•åˆ—ç´¢å¼•å¿« 30% - 50%
        @Index(columnList = "awardKey, awardConfig"),  
})
@Comment("å¥–å“")
```

## ğŸ’› å±æ€§æ³¨è§£
- `@Id` æŒ‡å®šä¸»é”®
- `@GeneratedValue` æŒ‡å®šæŸä¸ªå­—æ®µçš„å€¼æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œ**å¦‚æœæ˜¾å¼æŒ‡å®šï¼Œå°†è¦†ç›–è¯¥æ³¨è§£**
	- `strategy` 
		- `GenerationType.AUTO` ç”± JPA è‡ªåŠ¨é€‰æ‹©ï¼Œä¼šç”Ÿæˆåç¼€ `_SEQ` çš„è¡¨
		- `GenerationType.IDENTITY` è®©æ•°æ®åº“è‡ªå·±è‡ªå¢ï¼Œ~~é…ç½®äº†æ•°æ®åˆ†ç‰‡ä¸­çš„ä¸»é”®ç­–ç•¥ä¹Ÿè¦é€‰æ‹©è¿™ä¸ª~~
		- `GenerationType.SEQUENCE` ä½¿ç”¨æ•°æ®åº“çš„åºåˆ—æ¥ç”Ÿæˆä¸»é”®å€¼
		- `GenerationType.UUID` æ ¹æ® UUID ç”Ÿæˆä¸»é”®å€¼
	- `generator` å®šä¹‰ç”Ÿæˆå™¨çš„åå­—
- `GenericGenerator` æ·»åŠ ç”Ÿæˆå™¨
	- `name` å®šä¹‰ç”Ÿæˆå™¨çš„åå­—
	- `strategy` ç”Ÿæˆå™¨çš„å…¨é™å®šç±»å
- `@Column` é…ç½®åˆ—
	- `name` æŒ‡å®šåˆ—å
	- `columnDefinition` æŒ‡å®šæ•°æ®åº“å­—æ®µçš„æ•°æ®ç±»å‹
		- JSON
		- TEXT
		- DATETIME DEFAULT CURRENT_TIMESTAMP **åˆ›å»ºæ—¶é—´**
		- DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP **æ›´æ–°æ—¶é—´**
	- `nullable` 
		- true ~~é»˜è®¤~~
		- false æŒ‡å®šè¯¥å­—æ®µä¸å…è®¸ä¸ºç©º
	- `unique` 
		- true æŒ‡å®šè¯¥å­—æ®µæ˜¯å”¯ä¸€çš„
		- false ~~é»˜è®¤~~
	- `insertable` false è¡¨ç¤ºåœ¨æ’å…¥æ•°æ®æ—¶ï¼ŒJPA ä¸ä¼šä¸ºè¿™ä¸ªå­—æ®µæä¾›å€¼ï¼Œè€Œæ˜¯ç”±æ•°æ®åº“æ¥å¤„ç†
	- `updatable` false è¡¨ç¤ºåœ¨æ›´æ–°æ•°æ®æ—¶ï¼ŒJPA ä¸ä¼šä¸ºè¿™ä¸ªå­—æ®µæä¾›å€¼ï¼Œè€Œæ˜¯ç”±æ•°æ®åº“æ¥å¤„ç†
- `@Enumerated` 
	- EnumType.ORDINAL æŒ‡å®šæšä¸¾å€¼ï¼Œåœ¨æ•°æ®åº“ä¸­å­˜å‚¨çš„å½¢å¼ä¸ºæ•°å­—
	- EnumType.STRING æŒ‡å®šæšä¸¾å€¼ï¼Œåœ¨æ•°æ®åº“ä¸­å­˜å‚¨çš„å½¢å¼ä¸º String
- `@Comment` æ³¨é‡Šï¼ˆå°†å±•ç¤ºåœ¨æ•°æ®åº“ä¸­ï¼‰
- `@Transient` è¡¨ç¤ºè¯¥å­—æ®µä¸ä¼šæŒä¹…åŒ–åˆ° MongoDB ä¸­

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
@Entity
@Table(name = "tb_customer")
public class Customer {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "no")
    private Long no;
    @Column(name = "cust_name")
    private String custName;
    @Column(name = "cust_address")
    private String custAddress;
	
	@Column(columnDefinition = "TEXT")  
	@Convert(converter = ListLongToJsonConverter.class)  
	private List<Long> awardIds; // ç»‘å®šçš„å¥–å“é›†åˆ
    
    @Enumerated(EnumType.STRING)  
	private CustomerType type;
}
```

- `@Convert` ç»™å±æ€§å®šä¹‰è½¬æ¢å™¨ï¼Œ**æ¨è**
	- converter æŒ‡å®šå…·ä½“çš„è½¬æ¢å™¨ç±»
```java
/**  
 * å®ä½“
 */
@Entity
@Table(name = "tb_customer")
public class Customer {
	@Column(columnDefinition = "TEXT")  
	@Convert(converter = ListLongToJsonConverter.class)  
	private List<Long> awardIds; // ç»‘å®šçš„å¥–å“é›†åˆ
}

/**  
 * è½¬æ¢å™¨
 */
@Converter
public class ListLongToJsonConverter implements AttributeConverter<List<Long>, String> {

    private final ObjectMapper objectMapper = new ObjectMapper();

    @Override
    public String convertToDatabaseColumn(List<Long> longs) {
		return objectMapper.writeValueAsString(longs);
    }

    @Override
    public List<Long> convertToEntityAttribute(String dbData) {
		return objectMapper.readValue(dbData, new TypeReference<List<Long>>() {});
    }

}
```

## ğŸ’› æ–¹æ³•æ³¨è§£
`@PrePersist` å¯ä»¥åœ¨å®ä½“æ’å…¥ä¹‹å‰è§¦å‘ï¼Œ**ä¸æ”¯æŒ JPQL**
- é€šå¸¸ç”¨äºç»™å­—æ®µè¿›è¡Œåˆå§‹åŒ–
`@PreUpdate` å¯ä»¥åœ¨å®ä½“æ›´æ–°ä¹‹å‰è§¦å‘ï¼Œ**ä¸æ”¯æŒ JPQL**
- é€šå¸¸ç”¨äºæ›´æ–°æŸäº›å­—æ®µå€¼

```java
@Entity
public class Product {

    private LocalDateTime createdAt;
	private LocalDateTime updatedAt;

    @PrePersist
    public void setCreatedAt() {
        this.createdAt = LocalDateTime.now();
    }

    @PreUpdate
    public void setUpdatedAt() {
        this.updatedAt = LocalDateTime.now();
    }
}
```

## ğŸ’› ç”Ÿå‘½å‘¨æœŸå›è°ƒ
ç”¨ä»¥ä¸‹æ³¨è§£æ³¨é‡Šæ–¹æ³•å³å¯
- `@PostLoad` ä»æ•°æ®åº“åŠ è½½åˆ°å†…å­˜åè°ƒç”¨ï¼ŒJPQL çš„æŸ¥è¯¢å¯ä»¥ç”Ÿæ•ˆ
- `@PrePersist` å®ä½“è¢«æŒä¹…åŒ–ä¹‹å‰è°ƒç”¨
- `@PostPersist` å®ä½“è¢«æŒä¹…åŒ–ä¹‹åè°ƒç”¨
- `@PreUpdate` å®ä½“è¢«æ›´æ–°ä¹‹å‰è°ƒç”¨ï¼ŒJPQL çš„æ›´æ–°æ— æ³•ç”Ÿæ•ˆ
- `@PostUpdate` å®ä½“è¢«æ›´æ–°ä¹‹åè°ƒç”¨ï¼ŒJPQL çš„æ›´æ–°æ— æ³•ç”Ÿæ•ˆ
- `@PreRemove` å®ä½“è¢«åˆ é™¤ä¹‹å‰è°ƒç”¨ï¼ŒJPQL çš„æ›´æ–°æ— æ³•ç”Ÿæ•ˆï¼Œæ–¹æ³•å‘½åå¯ä»¥ç”Ÿæ•ˆ
- `@PostRemove` å®ä½“è¢«åˆ é™¤ä¹‹å‰è°ƒç”¨ï¼ŒJPQL çš„æ›´æ–°æ— æ³•ç”Ÿæ•ˆï¼Œæ–¹æ³•å‘½åå¯ä»¥ç”Ÿæ•ˆ

```java
@PostLoad
public void postLoad() {
	System.out.println("User.postLoad" + this);
}
```

## ğŸ’› æŠ€å·§ç¤ºä¾‹
<u>è‡ªåŠ¨èµ‹å€¼æ—¶é—´æˆ³</u> ï¼šä½¿ç”¨ `columnDefinition` å®šä¹‰æ•°æ®åº“æ•°æ®ç±»å‹
- ä½¿ç”¨ Audit ç›‘å¬å™¨æ— æ³•æ•è· EntityManagerã€@Query çš„æ“ä½œ

<u>åˆå§‹åŒ–é»˜è®¤å€¼</u> ï¼š
```java
// é»˜è®¤åˆå§‹åŒ–ä¸º 0
@Column(columnDefinition = "bigint default 0")  
private Long raffleTimes;  // ç”¨æˆ·çš„æŠ½å¥–æ¬¡æ•°
```

<u>åŠ¨æ€åˆå§‹åŒ–é»˜è®¤å€¼</u> ï¼š
```java
@Builder.Default  
private Long activityOrderId = IdUtil.getSnowflakeNextId();
```

<u>ä½¿ç”¨ Java æ–¹æ³•åŠ¨æ€ç”Ÿæˆé»˜è®¤å€¼</u> ï¼šä¸æ¨èï¼Œå†™ç€ç©å„¿çš„
- å®šä¹‰æ³¨è§£
```java
/**
 * ä¸ºå®ä½“çš„å­—æ®µæä¾›é»˜è®¤çš„ç”Ÿæˆé€»è¾‘
 *
 * ç¤ºä¾‹ï¼š
 * - @JpaDefaultValue(howToCreate = "cn.hutool.core.util.IdUtil.getSnowflakeNextId()")
 * - private Long activityOrderId;
 * - @JpaDefaultValue(howToCreate = "java.time.LocalDateTime.of(2000, 12, 31, 0, 0, 0)")
 * - private LocalDateTime activityOrderEffectiveTime;
 */
@Target(ElementType.FIELD)  // åªèƒ½åº”ç”¨äºå­—æ®µ
@Retention(RetentionPolicy.RUNTIME)  // åœ¨è¿è¡Œæ—¶ä¿ç•™
public @interface JpaDefaultValue {
    String howToCreate();  // æŒ‡å®šé»˜è®¤å€¼ç”Ÿæˆæ–¹æ³•
}
```
- æ³¨è§£ç±»
```java
public class JpaDefaultValueListener {

    @PrePersist
    @SneakyThrows
    public void prePersist(Object entity) {
        Field[] fields = entity.getClass().getDeclaredFields();
        for (Field field : fields) {
            JpaDefaultValue annotation = field.getAnnotation(JpaDefaultValue.class);
            if (annotation != null) {
                field.setAccessible(true);
                Object value = field.get(entity);

                if (value == null) {
                    String howToCreate = annotation.howToCreate();

                    // åˆ†ç¦»æ–¹æ³•è·¯å¾„å’Œå‚æ•°éƒ¨åˆ†
                    int paramStartIndex = howToCreate.indexOf('(');
                    int paramEndIndex = howToCreate.lastIndexOf(')');

                    if (paramStartIndex == -1 || paramEndIndex == -1) {
                        throw new IllegalArgumentException("howToCreate æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘æ‹¬å·");
                    }

                    // æå–æ–¹æ³•è·¯å¾„å’Œå‚æ•°
                    String methodPath = howToCreate.substring(0, paramStartIndex).trim();
                    String paramString = howToCreate.substring(paramStartIndex + 1, paramEndIndex).trim();

                    // åˆ†ç¦»ç±»åå’Œæ–¹æ³•å
                    String[] parts = methodPath.split("\\.");
                    String className = String.join(".", Arrays.copyOf(parts, parts.length - 1));
                    String methodName = parts[parts.length - 1];

                    // è§£æå‚æ•°
                    Object[] params = parseParameters(paramString);
                    Class<?>[] paramTypes = Arrays.stream(params).map(this::getPrimitiveType).toArray(Class<?>[]::new);

                    // è·å–ç±»å’Œæ–¹æ³•
                    Class<?> clazz = Class.forName(className);
                    Method method = clazz.getDeclaredMethod(methodName, paramTypes);

                    // è°ƒç”¨æ–¹æ³•ç”Ÿæˆå€¼
                    Object generatedValue = method.invoke(null, params);

                    // æ£€æŸ¥ç”Ÿæˆå€¼çš„ç±»å‹æ˜¯å¦åŒ¹é…
                    if (field.getType().isAssignableFrom(generatedValue.getClass())) {
                        field.set(entity, generatedValue);
                    } else {
                        throw new RuntimeException("ç”Ÿæˆå™¨ç±»å‹ä¸å±æ€§ç±»å‹ä¸åŒ¹é…");
                    }
                }
            }
        }
    }

    /**
     * è§£æå‚æ•°å­—ç¬¦ä¸²ä¸ºå‚æ•°æ•°ç»„
     *
     * @param paramString å‚æ•°å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ "2000, 12, 31, 0, 0, 0"ï¼‰
     * @return è½¬æ¢åçš„å‚æ•°æ•°ç»„
     */
    private Object[] parseParameters(String paramString) {
        if (paramString.isEmpty()) {
            return new Object[0];
        }

        // ç®€å•å®ç°ï¼šæ ¹æ®é€—å·åˆ†éš”å¹¶å°è¯•è§£æå¸¸è§ç±»å‹ï¼ˆint, long, double, String ç­‰ï¼‰
        String[] parts = paramString.split(",");
        Object[] params = new Object[parts.length];

        for (int i = 0; i < parts.length; i++) {
            String part = parts[i].trim();

            // å°è¯•è§£æä¸ºæ•°å­—
            if (part.matches("-?\\d+")) {
                params[i] = Integer.parseInt(part);
            } else if (part.matches("-?\\d+L")) {
                params[i] = Long.parseLong(part.substring(0, part.length() - 1));
            } else if (part.matches("-?\\d+\\.\\d+")) {
                params[i] = Double.parseDouble(part);
            } else if (part.matches("-?\\d+\\.\\d+f")) {
                params[i] = Float.parseFloat(part.substring(0, part.length() - 1));
            } else if (part.startsWith("\"") && part.endsWith("\"")) {
                // è§£æä¸ºå­—ç¬¦ä¸²
                params[i] = part.substring(1, part.length() - 1);
            } else if (part.equalsIgnoreCase("true") || part.equalsIgnoreCase("false")) {
                params[i] = Boolean.parseBoolean(part);
            } else {
                throw new IllegalArgumentException("æ— æ³•è§£æå‚æ•°: " + part);
            }
        }

        return params;
    }

    /**
     * è·å–åŒ…è£…ç±»å‹å¯¹åº”çš„åŸºæœ¬ç±»å‹
     *
     * @param obj å‚æ•°å¯¹è±¡
     * @return åŸºæœ¬ç±»å‹ï¼ˆå¦‚æœæ˜¯åŒ…è£…ç±»å‹åˆ™è¿”å›å…¶åŸºæœ¬ç±»å‹ï¼Œå¦åˆ™è¿”å›å¯¹è±¡çš„å®é™…ç±»å‹ï¼‰
     */
    private Class<?> getPrimitiveType(Object obj) {
        if (obj instanceof Integer) {
            return int.class;
        } else if (obj instanceof Long) {
            return long.class;
        } else if (obj instanceof Double) {
            return double.class;
        } else if (obj instanceof Float) {
            return float.class;
        } else if (obj instanceof Boolean) {
            return boolean.class;
        } else if (obj instanceof Character) {
            return char.class;
        } else if (obj instanceof Byte) {
            return byte.class;
        } else if (obj instanceof Short) {
            return short.class;
        }
        return obj.getClass(); // å¦‚æœä¸æ˜¯åŒ…è£…ç±»å‹ï¼Œç›´æ¥è¿”å›å®é™…ç±»å‹
    }

}
```
- ä½¿ç”¨
```java
@Entity  
@EntityListeners(JpaDefaultValueListener.class)  // æ·»åŠ æ³¨è§£å¤„ç†å™¨
@Table(name = "ActivityOrderFlow")  
public class ActivityOrderFlow {  
    @JpaDefaultValue(howToCreate = "cn.hutool.core.util.IdUtil.getSnowflakeNextId()")  
    private Long activityOrderId;
    @JpaDefaultValue(howToCreate = "java.time.LocalDateTime.of(2000, 12, 31, 0, 0, 0)")  
    private LocalDateTime activityOrderEffectiveTime;
}
```

<u>è‡ªå®šä¹‰ id ç”Ÿæˆ</u> ï¼š
```java
public class SnowflakeIdGenerator implements IdentifierGenerator {
    @Override
    public Serializable generate(SharedSessionContractImplementor session, Object object) {
        return IdUtil.getSnowflakeNextId();
    }
}
```

```java
@Id  
@GeneratedValue(generator = "SnowflakeIdGenerator")  
@GenericGenerator(name = "SnowflakeIdGenerator", strategy = "app.xlog.ggbond.persistent.util.SnowflakeIdGenerator")  
private Long id;
```

<u>å®šä¹‰åŸºç±»</u> ï¼šå­ç±»å¯ä»¥ç»§æ‰¿åŸºç±»çš„å±æ€§ï¼ˆ~~æ¯”å¦‚é€šç”¨çš„ idã€createTimeã€updateTime éƒ½å¯ä»¥ä½¿ç”¨åŸºç±»å®šä¹‰~~ï¼‰
```java
@MappedSuperclass  
public class ShardingTableBaseEntity {  
    @Id  
    @GeneratedValue(strategy = GenerationType.IDENTITY)  
    private Long id;  
    @Column(columnDefinition = "DATETIME DEFAULT CURRENT_TIMESTAMP", insertable = false, updatable = false)  
    private LocalDateTime createTime;  
    @Column(columnDefinition = "DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP", insertable = false, updatable = false)  
    private LocalDateTime updateTime;  
}

@Entity   
public class Award extends ShardingTableBaseEntity { â€¦â€¦ }
```















