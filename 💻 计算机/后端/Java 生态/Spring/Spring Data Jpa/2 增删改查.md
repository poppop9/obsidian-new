
# â¤ï¸ JpaRepository
JpaRepository ä¸­æœ‰è®¸å¤šé»˜è®¤æ–¹æ³•ï¼Œ**ä¹Ÿå¯ä»¥åœ¨ç»§æ‰¿äº† JpaRepository çš„æ¥å£ä¸­è‡ªå®šä¹‰æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¼šæ ¹æ®æ–¹æ³•åè‡ªåŠ¨ç”Ÿæˆç›¸åº”æ¡ä»¶çš„ SQL è¯­å¥ï¼Œæ— éœ€é¢å¤–é…ç½®**

```java
// JpaRepository<å®ä½“åï¼Œä¸»é”®çš„æ•°æ®ç±»å‹>
@Repository
public interface CustomerRepository extends JpaRepository<Customer, Long> {

    Customer save(Customer customer);

	// æŸ¥è¯¢æ¥å£
    Optional<Customer> findById(Long id);

    List<Customer> findByCustName(String custName);
}
```

> [!NOTE] å¦‚æœä½ å®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿è‡ª `Repository` æ¥å£çš„è‡ªå®šä¹‰æ¥å£ï¼ŒSpring å®¹å™¨ä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºè¿™ä¸ªæ¥å£çš„å®ä¾‹ï¼Œå¹¶æ³¨å…¥åˆ° IOC å®¹å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦åŠ  `@Repository` 

## ğŸ’› æ–°å¢ï¼Œä¿®æ”¹

> [!warning] ä¸æ¨èä½¿ç”¨ save æ–¹æ³•å» updateï¼Œå› ä¸º save æ–¹æ³•æ˜¯å…ˆ select æ¥åˆ¤æ–­æ˜¯è¦ createï¼Œè¿˜æ˜¯ updateï¼Œè¿™å¢åŠ äº†å¼€é”€

> [!warning] `save` æ—¢å¯ä»¥ Cï¼Œä¹Ÿå¯ä»¥ Uï¼š
> - ä¸»é”®ä¸ºç©º >>> C
> - ä¸»é”®ä¸å­˜åœ¨ >>> C
> - ä¸»é”®å·²å­˜åœ¨ >>> U
> 
> å½“ç„¶ï¼Œå¯ä»¥å®ç° Persistable æ¥å£ï¼Œæ¥è‡ªå®šä¹‰åˆ¤æ–­é€»è¾‘

- `save(å®ä½“å¯¹è±¡)` å¢æ”¹ï¼Œä½†æ˜¯ä¼šç­‰å¾…ä¸€ä¸ªäº‹åŠ¡çš„æäº¤ï¼Œå…¶æ‰ä¼šå½±å“åˆ°æ•°æ®åº“
- `saveAll(é›†åˆ)` æ‰¹é‡å¢æ”¹
- `saveAndFlush(å®ä½“å¯¹è±¡)` å¢æ”¹ï¼Œå¹¶ç«‹å³æäº¤è¿™ä¸ªæ“ä½œ
- `saveAllAndFlush(é›†åˆ)` 

```java
// ä¸å¸¦ä¸»é”®ï¼Œå°±æ˜¯æ–°å¢
customerRepository.save(new Customer(null, 33L, "nelson", "France"));

// å¸¦ä¸»é”®ï¼Œå°±æ˜¯ä¿®æ”¹
customerRepository.save(new Customer(1L, 2L, "Kite", "Japen"));
```

```java
customerRepository.saveAllAndFlush(List.of(
	new Customer(null, 33L, "nelson", "France"),
	new Customer(null, 33L, "nelson", "France")
));
```

## ğŸ’› æŸ¥
- ã€æ™®é€šã€‘
	- `findAll()` æ— æ¡ä»¶æŸ¥
	- `findAllById(idé›†åˆ)` 
- ã€æ¡ä»¶ã€‘
	- `findAll(Example æ¡ä»¶å¯¹è±¡)` 
- ã€æ’åºã€‘
	- `findAll(Sort æ’åºå¯¹è±¡)` 

---

```java
// æ„é€ æ¡ä»¶
Example<Customer> example1 = Example.of(new Customer(null, 33L, null, null));  // nullå€¼ä¸ä¼šä½œä¸ºæ¡ä»¶æ‹¼æ¥åˆ°whereæ¡ä»¶ä¸­
// æ„é€ æ’åºè§„åˆ™
Sort sort = Sort.by("custName").descending();

customerRepository.findAll(example1, sort);
```

### ğŸ’™ Example
- `Example.of(å®ä½“å¯¹è±¡)` 
- `Example.of(å®ä½“å¯¹è±¡, ExampleMatcher)` æ”¯æŒæ¨¡ç³Šï¼ŒèŒƒå›´ï¼Œå¿½ç•¥å¤§å°å†™æŸ¥è¯¢

> [!warning] 
> - æ”¯æŒåŠ¨æ€æ¡ä»¶ï¼Œå¦‚æœå€¼ä¸º nullï¼Œåˆ™ä¸æ‹¼æ¥è¯¥ WHERE æ¡ä»¶
> - ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢

## ğŸ’› å…¶ä»–æ–¹æ³•
<u>åˆ¤æ–­æ˜¯å¦å­˜åœ¨</u> ï¼š
- `Boolean existsById(id)` çœ‹å¯¹åº” id çš„æ•°æ®æ˜¯å¦å­˜åœ¨
- `Boolean exists(Example æ¡ä»¶å¯¹è±¡)` å¤æ‚æ¡ä»¶æŸ¥è¯¢æ•°æ®æ˜¯å¦å­˜åœ¨

```java
System.out.println(customerRepository.existsById(1L));  
```

```java
// æ„å»ºæ¡ä»¶ï¼Œidä¸º1ï¼Œå¹¶ä¸”nameä¸ºKiteçš„æ•°æ®
Example<Customer> example = Example.of(new Customer(1L, null, "Kite", null));  

System.out.println(customerRepository.exists(example));  
```

---

<u>åˆ¤æ–­æ•°é‡</u> ï¼š
- `count()` 
- `count(Example æ¡ä»¶å¯¹è±¡)`

```java
long count = customerRepository.count();
System.out.println(count);
```


å½“ä½ åœ¨å®šä¹‰ `@Bean` æ³¨è§£çš„æ–¹æ³•å‚æ•°ä¸­ä½¿ç”¨ Repository æ¥å£æ—¶ï¼ŒSpring ä¼šè‡ªåŠ¨æ³¨å…¥ç›¸åº”çš„ Repository å®ä¾‹ï¼Œä½ ä¸éœ€è¦æ‰‹åŠ¨è¿›è¡Œä¾èµ–æ³¨å…¥

## ğŸ’› SimpleJpaRepository

# â¤ï¸ æ–¹æ³•åæ´¾ç”Ÿ
[å…³é”®è¯](https://docs.spring.io/spring-data/jpa/reference/repositories/query-keywords-reference.html#appendix.query.method.subject)

> [!NOTE] é€šè¿‡æ–¹æ³•åçš„è¯­ä¹‰è‡ªåŠ¨ç”Ÿæˆ sqlï¼Œæ”¯æŒ RDï¼Œä¸æ”¯æŒ CU

## ğŸ’› æŸ¥
`find ç»“æœé™åˆ¶æ¡ä»¶ By æ¡ä»¶ Ignore å¿½ç•¥æ¡ä»¶ OrderBy æ’åºæ¡ä»¶`

<u>ç»“æœé™åˆ¶æ¡ä»¶</u> ï¼š
- `Distinct` é™åˆ¶ç»“æœä¸é‡å¤
- `First` 
- ~~`One` ä¸æ¨èä½¿ç”¨ï¼Œå¦‚æœæ•°æ®è®°å½•æœ‰å¤šä¸ªï¼Œä¼šæŠ¥é”™~~
- `TopN` é™åˆ¶ç»“æœæ•°ä¸º N ä¸ª 

```java
findDistinctByName
```

<u>æ¡ä»¶åç§°</u> ï¼š

```java
// é¦–å…ˆä¼šå»Personç±»ä¸­æ‰¾addressZipCodeå±æ€§ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°ï¼Œé‚£å°± â€¦â€¦
// æ‰¾Personç±»ä¸­addresså±æ€§çš„å­å±æ€§zipCodeï¼Œç„¶åä½œä¸ºæ¡ä»¶
List<Person> findByAddressZipCode(ZipCode zipCode);
```

```java
// æ ¹æ®emailAddresså’Œlastnameå¿½ç•¥å¤§å°å†™çš„æŸ¥æ‰¾ï¼Œç»“æœå»é‡ï¼Œå¹¶æ ¹æ®Firstnameè¿›è¡Œå‡åºæ’åº
findDistinctByEmailAddressAndLastnameAllIgnoreCaseOrderByFirstnameAsc(EmailAddress emailAddress, String lastname)
```

# â¤ï¸ è‡ªå®šä¹‰ sql
å¯ä»¥ä½¿ç”¨ [QueryRewriter](https://docs.spring.io/spring-data/jpa/reference/jpa/query-methods.html#jpa.query-methods.query-rewriter) åŠ¨æ€æ›´æ”¹å·²å®šä¹‰çš„ sql ï¼Œç±»ä¼¼ AOP #å¾…å­¦ä¹  

> [!warning] 
> - æ”¯æŒç¼–å†™ sql å®ç°èŒƒå›´æŸ¥è¯¢
> - ä¸æ”¯æŒåŠ¨æ€æŸ¥è¯¢ï¼Œå¦‚æœå€¼ä¸º nullï¼Œä¹Ÿä¼šæ‹¼æ¥è¿› sql

## ğŸ’› æŸ¥
- `Like` / `NotLike` æ¨¡ç³ŠæŸ¥è¯¢ï¼Œéœ€è¦ä¸é€šé…ç¬¦ç»“åˆä½¿ç”¨
- `Contains` åŒ…å«æ¨¡ç³ŠæŸ¥è¯¢ï¼Œç›¸å½“äº `Like %â€¦â€¦%` 
- `StartsWith` / `EndsWith` æŸ¥è¯¢æŒ‡å®šå‰ç¼€/åç¼€å¼€å¤´
- `In` / `NotIn` å­—ç¬¦ä¸²åœ¨æŒ‡å®šé›†åˆä¸­
- `Null` / `NotNull` 

```java
public interface UserRepository extends JpaRepository<User, Long> {
    // ä¼ å…¥çš„firstnameï¼Œlastnameå‚æ•°ä¼šè¢«æ³¨å…¥åˆ°sqlä¸­
	@Query("select u from User u where u.emailAddress = ?1")
	User findByEmailAddress(String emailAddress);

	@Query("select u from User u where u.firstname like %?1")
	List<User> findByFirstnameEndsWith(String firstname);
}
```

## ğŸ’› åˆ æ”¹
https://docs.spring.io/spring-data/jpa/reference/jpa/query-methods.html#jpa.modifying-queries
