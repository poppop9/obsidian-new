# â¤ é™æ€ä»»åŠ¡
> [!quote] é™æ€ä»»åŠ¡
> é™æ€ä»»åŠ¡ æ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶å°±è¢«åŠ è½½å’Œæ³¨å†Œçš„å®šæ—¶ä»»åŠ¡ï¼Œè°ƒåº¦æ—¶é—´åœ¨åº”ç”¨å¯åŠ¨æ—¶å°±è¢«è®¡ç®—ã€‚å®ƒä»¬æ˜¯åŸºäºé…ç½®æ–‡ä»¶æˆ–ä»£ç ä¸­çš„ `@Scheduled` æ³¨è§£å£°æ˜çš„

```java
@Scheduled(cron="0 0 2 * * ?")  //æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
public void doStaticTask() {
    // æ‰§è¡Œé™æ€å®šæ—¶ä»»åŠ¡çš„ä»£ç 
}
```

## ğŸ’› æ“ä½œæ­¥éª¤
- åœ¨å¯åŠ¨ç±»ä¸ŠåŠ å…¥ `@EnableScheduling`
- ä½¿ç”¨ `@Scheduled`ï¼Œå¯¹ä»»åŠ¡<u>è®¾ç½®æ‰§è¡Œæ—¶é—´</u>ã€‚æœ‰ä¸‰ç§é…ç½®æ‰§è¡Œæ—¶é—´çš„æ–¹å¼ï¼š
	- `cron è¡¨è¾¾å¼` 
	- `fixedRate` è‡ªä¸Šä¸€æ¬¡æ‰§è¡Œå¼€å§‹ä¹‹åå¤šé•¿æ—¶é—´æ‰§è¡Œã€~~å•ä½æ˜¯æ¯«ç§’~~ã€‘
	- `fixedRateString` ä¸ `fixedRate` ç›¸åŒï¼Œä½†æ˜¯<u>æ”¯æŒå ä½ç¬¦</u>
	- `fixedDelay` è‡ªä¸Šä¸€æ¬¡æ‰§è¡Œç»“æŸä¹‹åå¤šé•¿æ—¶é—´æ‰§è¡Œã€~~å•ä½æ˜¯æ¯«ç§’~~ã€‘
	- `fixedDelayString`
	- `initialDelay` é¦–æ¬¡æ‰§è¡Œè¦å»¶è¿Ÿå¤šé•¿æ—¶é—´ã€~~å•ä½æ¯«ç§’~~ã€‘
	- `initialDelayString`

```java
@Scheduled(cron = "0/20 * * * * ?")  

@Scheduled(fixedRate = 1 * 60 * 1000)  

// é…ç½®æ–‡ä»¶ä¸­
interval=2000
@Scheduled(fixedRateStirng="${interval}")
public void RunSchedule() {â€¦â€¦}
```

## ğŸ’› @Scheduled
### ğŸ’™ Cron è¡¨è¾¾å¼
`cron= "ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨å‡ "`

> [!warning] `å‘¨` å’Œ `æ—¥` ä¸èƒ½åŒæ—¶å­˜åœ¨ã€ä¸€ä¸ªè®¾ç½®äº†ï¼Œå¦ä¸€ä¸ªå°±è¦è®¾ç½®ä¸º `?` ã€‘

- å–å€¼
	- `ç§’` 0-59
	- `åˆ†` 0-59
	- `æ—¶` 0-23
	- `æ—¥` 1-31
	- `æœˆ` 1-12
	- `å‘¨` 0-7ã€0/7 æ˜¯ å‘¨æ—¥ï¼Œ1-6 æ˜¯å‘¨ä¸€åˆ°å‘¨å…­ã€‘
- é€šé…ç¬¦
	- `#` æ¯æœˆçš„ç¬¬å‡ ä¸ªå‘¨å‡ ã€æ¯”å¦‚ `1#2`ï¼Œè¡¨ç¤ºæ¯æœˆçš„ç¬¬ 2 ä¸ªæ˜ŸæœŸå¤©ã€‘ã€==åªç”¨åœ¨å‘¨==ã€‘
	- `L` æ¯æœˆçš„æœ€åä¸€ä¸ªä»€ä¹ˆã€æ¯”å¦‚ï¼Œåœ¨æ—¥ä¸Š `3L` è¡¨ç¤ºè¿™ä¸ªæœˆçš„å€’æ•°ç¬¬ä¸‰å¤©ï¼Œå‘¨ä¸Š `3L` è¡¨ç¤ºè¿™ä¸ªæœˆçš„æœ€åä¸€ä¸ªå‘¨å››ã€==åªç”¨åœ¨å‘¨ï¼Œæˆ–æ—¥==ã€‘ã€Spring ä¸­ä¸æ”¯æŒã€‘
	- `*` æ‰€æœ‰å€¼ï¼Œè¡¨ç¤ºæ¯ç§’ï¼Œæ¯æœˆï¼Œæ¯æ—¥
	- `?` ä¸æŒ‡å®šå€¼ã€æ¯”å¦‚å·²ç»è®¾ç½®äº†æ¯æ—¥ï¼Œé‚£å…·ä½“å‘¨å‡ å°±ä¸ç”¨è®¾ç½®äº†ï¼Œé‚£ä¹ˆå°±è®¾ä¸º `?` ã€‘
	- `-` è¡¨ç¤ºåŒºé—´ã€æ¯”å¦‚åœ¨å‘¨ä¸Šè®¾ç½® `3-5`ï¼Œå°±è¡¨ç¤ºå‘¨ä¸‰åˆ°å‘¨äº”éƒ½ä¼šæ‰§è¡Œã€‘
	- `,` å¤šä¸ªå¹¶åˆ—ã€æ¯”å¦‚æ—¥çš„ `2,13,14`ï¼Œå°±æ˜¯ 2 å·ï¼Œ13 å·ï¼Œ14 å·éƒ½ä¼šæ‰§è¡Œã€‘
	- `/` é—´éš”ã€æ¯”å¦‚ç§’çš„ `2/3`ï¼Œä»ç¬¬ 2 ç§’å¼€å§‹ï¼Œæ¯ä¸‰ç§’è§¦å‘ä¸€æ¬¡ã€‘

```java
0/2 * * * * ?   ä»ç¬¬ 0 ç§’å¼€å§‹ï¼Œæ¯ 2 ç§’è§¦å‘

0 0/5 14 * * ?    åœ¨æ¯å¤©ä¸‹åˆ 2 ç‚¹åˆ°ä¸‹åˆ 2:55 æœŸé—´çš„æ¯5åˆ†é’Ÿè§¦å‘ã€2 ç‚¹ä¼šè§¦å‘ï¼Œ2:55 ä¹Ÿä¼šè§¦å‘ã€‘

0 15 10 ? * 6#3   æ¯æœˆçš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”ä¸Šåˆ 10:15 è§¦å‘

0 0 2 1 * ?   æ¯æœˆçš„ 1 å·ï¼Œå‡Œæ™¨ 2 ç‚¹è§¦å‘

0 * 14 * * ?    æ¯å¤©ä¸‹åˆ 2 ç‚¹åˆ°ä¸‹åˆ 2:59 çš„æ¯ 1 åˆ†é’Ÿè§¦å‘

0 0-5 14 * * ?    æ¯å¤©ä¸‹åˆ 2 ç‚¹åˆ°ä¸‹åˆ 2:05 çš„æ¯ 1 åˆ†é’Ÿè§¦å‘ 
```

### ğŸ’™ fixedRate
fixedRate çš„æ—¶é—´å•ä½æ˜¯æ¯«ç§’

```java
@Scheduled(fixedRate = 6300000) // 1h 45min
```

### ğŸ’™ fixedRateString
```java
// é…ç½®æ–‡ä»¶
interval=2000

// æ³¨è§£å¼•ç”¨
@Scheduled(fixedRateStirng="${interval}")
```

### ğŸ’™ initialDelay
```java
// ç³»ç»Ÿå¯åŠ¨ä¹‹åç«‹é©¬ä¼šæ‰§è¡Œä¸€æ¬¡
@Scheduled(fixedRate = 6300000, initialDelay = 0)
```

## ğŸ’› å®šæ—¶è°ƒåº¦å¼‚æ­¥çº¿ç¨‹æ± 

> [!quote] å®šæ—¶è°ƒåº¦å¼‚æ­¥çº¿ç¨‹æ± 
> å®šæ—¶è°ƒåº¦å¼‚æ­¥çº¿ç¨‹æ±  **æ—¢ç”¨æ¥è°ƒåº¦ä»»åŠ¡ï¼Œä¹Ÿç”¨æ¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡**
> 
> - å¦‚æœä¸é¢å¤–åˆ›å»ºçº¿ç¨‹æ± ï¼Œé‚£æ‰€æœ‰çš„å®šæ—¶ä»»åŠ¡éƒ½ä¼šä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ± ï¼ˆå¤§å°ä¸º 1ï¼‰
> - é…ç½®å¥½çš„çº¿ç¨‹æ± ï¼Œåœ¨è¢« `@Scheduled` è‡ªåŠ¨åº”ç”¨
> - å½“ä»»åŠ¡å¼€å§‹è°ƒåº¦æ—¶ï¼Œä¼šæŠŠä»»åŠ¡æ”¾è¿›é˜Ÿåˆ—ä¸­ï¼Œåˆ°è¾¾æŒ‡å®šæ—¶é—´åï¼Œå†ä»ä½¿ç”¨çº¿ç¨‹æ¥æ‰§è¡Œè¯¥ä»»åŠ¡

```java
/**
 * å¼‚æ­¥å®šæ—¶ä»»åŠ¡é…ç½®ç±»
 */
@EnableScheduling
@Configuration
public class AsyncSchedulingConfig {
    @Bean(name = "myScheduledThreadPool")
    public ThreadPoolTaskScheduler myScheduledThreadPool() {
        ThreadPoolTaskScheduler scheduler = new ThreadPoolTaskScheduler();
        scheduler.setPoolSize(20); // è®¾ç½®çº¿ç¨‹æ± å¤§å°
        scheduler.setThreadNamePrefix("MyScheduledThreadPool - ");
        scheduler.initialize();

        return scheduler;
    }
}
```

# â¤ åŠ¨æ€ä»»åŠ¡
åŠ¨æ€ä»»åŠ¡æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ å’Œç§»é™¤çš„å®šæ—¶ä»»åŠ¡ï¼Œè€Œä¸éœ€è¦é‡æ–°å¯åŠ¨åº”ç”¨

## ğŸ’› åŠ¨æ€ Cron
```java
@Component
public class DynamicTaskScheduler {

    private ScheduledFuture<?> currentTask;
    
    @Resource
    private ThreadPoolTaskScheduler scheduler;

    public void scheduleTask(String cron) {
        // å¦‚æœæœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå–æ¶ˆå®ƒ
        if (currentTask != null && !currentTask.isCancelled()) {
            currentTask.cancel(true);
        }

        // è°ƒåº¦æ–°çš„ä»»åŠ¡
        currentTask = scheduler.schedule(() -> {
            // æ‰§è¡ŒåŠ¨æ€å®šæ—¶ä»»åŠ¡çš„ä»£ç 
        }, new CronTrigger(cron));
    }
}
```

## ğŸ’› åŠ¨æ€å»¶æ—¶ä»»åŠ¡
- `ScheduledExecutorService` ç”¨äºç®¡ç†å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œ
- `ScheduledFuture` æŒæœ‰å®šæ—¶ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œç»“æœï¼Œç”¨äºå–æ¶ˆä»»åŠ¡ï¼Œæˆ–æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œ**åœ¨è°ƒç”¨ scheduler.schedule() æ—¶ç«‹å³ç”Ÿæˆ**
	- `isCancelled`
		- false ä»»åŠ¡æ­£å¸¸è¿›è¡Œï¼Œç»“æŸï¼Œæ‰§è¡Œä¸­ï¼Œæ‰§è¡ŒæŠ¥é”™
		- true åªæœ‰å½“æˆ‘ä»¬æ‰‹åŠ¨ç»“æŸä»»åŠ¡ï¼Œæ‰ä¼šè¿”å›
	- `cancel(Boolean)` 
		- ä¼  true - ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
		- ä¼  false - ä¸ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½†ä¼šå–æ¶ˆè®¡åˆ’ä»»åŠ¡ï¼ˆåç»­ä¸å†æ‰§è¡Œï¼‰

> [!warning] åœ¨å¼€å¯è°ƒåº¦ä»»åŠ¡æ—¶ï¼Œä¸ä¼šå ç”¨çº¿ç¨‹ï¼Œåªæœ‰åœ¨å»¶æ—¶ç»“æŸå®é™…æ‰§è¡Œæ—¶æ‰ä¼šå ç”¨çº¿ç¨‹ï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç«‹é©¬é‡Šæ”¾çº¿ç¨‹èµ„æº

```java
/**
 * å·¥æ—¶å®¡æ‰¹é€šçŸ¥å®šæ—¶ä»»åŠ¡
 */
@Configuration
public class WHApprovalNotifyTask {

    // è¿™é‡Œè¦æå‰å®šä¹‰å¥½ä¸€ä¸ªåŠ¨æ€çº¿ç¨‹æ± 
	@Resource
	private ThreadPoolTaskScheduler taskScheduler;

    private ScheduledFuture<?> scheduledFuture;

    /** å¼€å¯å®šæ—¶ä»»åŠ¡ï¼Œæœ‰äººç™»è®°å·¥æ—¶ï¼Œå°±è°ƒç”¨è¯¥æ–¹æ³• */
    public void scheduleTask(Integer delay) {
	    // ä»»åŠ¡åœ¨delayå°æ—¶åæ‰§è¡Œ
		scheduledFuture = taskScheduler.schedule(  
		        () -> {  
					// åˆ¤æ–­å–æ¶ˆä»»åŠ¡
					if (scheduledFuture != null) scheduledFuture.cancel(false);
					// æ‰§è¡Œä»»åŠ¡
					notifyByUserIds();
		        },  
		        Instant.now().plus(delay, ChronoUnit.HOURS)  
		);
    }

}
```









