```xml
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-spring-boot3-starter</artifactId>
    <version>1.42.0</version>
</dependency>
```

# â¤ï¸ ç™»å½•è®¤è¯ Â· é‰´æƒæµç¨‹
```mermaid
sequenceDiagram
    participant å®¢æˆ·ç«¯
    participant æœåŠ¡ç«¯

    å®¢æˆ·ç«¯->>æœåŠ¡ç«¯: æºå¸¦ç”¨æˆ·åå¯†ç è¿›è¡Œç™»å½•è®¤è¯
    æœåŠ¡ç«¯->>æœåŠ¡ç«¯: æ ¡éªŒæ˜¯å¦æ­£ç¡®
    æœåŠ¡ç«¯->>å®¢æˆ·ç«¯: è¿”å›è®¤è¯ç»“æœï¼Œå¦‚æœæ­£ç¡®åˆ™æ”¾å›çš„è¯·æ±‚å¤´ä¸­ä¼šæœ‰Set-Cookieå­—æ®µ
    å®¢æˆ·ç«¯->>å®¢æˆ·ç«¯: æ£€æµ‹åˆ°æœ‰Set-Cookieå­—æ®µï¼Œå°†å…¶å†™å…¥è‡ªå·±çš„è¯·æ±‚Cookieä¸­
```

# â¤ï¸ é…ç½®æ–‡ä»¶
```yml   
sa-token: 
    token-name: satoken  # token åç§°ï¼ˆåŒæ—¶ä¹Ÿæ˜¯ cookie åç§°ï¼‰
    timeout: 2592000  # token æœ‰æ•ˆæœŸï¼ˆå•ä½ï¼šç§’ï¼‰ é»˜è®¤30å¤©ï¼Œ-1 ä»£è¡¨æ°¸ä¹…æœ‰æ•ˆ
    active-timeout: -1  # token æœ€ä½æ´»è·ƒé¢‘ç‡ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œå¦‚æœ token è¶…è¿‡æ­¤æ—¶é—´æ²¡æœ‰è®¿é—®ç³»ç»Ÿå°±ä¼šè¢«å†»ç»“ï¼Œé»˜è®¤-1 ä»£è¡¨ä¸é™åˆ¶ï¼Œæ°¸ä¸å†»ç»“
    is-concurrent: true  # æ˜¯å¦å…è®¸åŒä¸€è´¦å·å¤šåœ°åŒæ—¶ç™»å½• ï¼ˆä¸º true æ—¶å…è®¸ä¸€èµ·ç™»å½•, ä¸º false æ—¶æ–°ç™»å½•æŒ¤æ‰æ—§ç™»å½•ï¼‰
    is-share: true  # åœ¨å¤šäººç™»å½•åŒä¸€è´¦å·æ—¶ï¼Œæ˜¯å¦å…±ç”¨ä¸€ä¸ª token ï¼ˆä¸º true æ—¶æ‰€æœ‰ç™»å½•å…±ç”¨ä¸€ä¸ª token, ä¸º false æ—¶æ¯æ¬¡ç™»å½•æ–°å»ºä¸€ä¸ª tokenï¼‰
    token-style: uuid  # token é£æ ¼ï¼ˆé»˜è®¤å¯å–å€¼ï¼šuuidã€simple-uuidã€random-32ã€random-64ã€random-128ã€tikï¼‰
    is-log: true  # æ˜¯å¦è¾“å‡ºæ“ä½œæ—¥å¿— 
```

# â¤ï¸ ç™»å½•è®¤è¯
- ã€ç™»å½•ã€‘
	- `StpUtil.login(ç”¨æˆ·id)` ç™»å½•è¯¥ç”¨æˆ·ï¼Œ**å…·ä½“åˆ¤æ–­è¿™ä¸ªç”¨æˆ·æ­£ä¸æ­£ç¡®ï¼Œè¦è‡ªå·±åˆ¤æ–­**
	- `StpUtil.login(ç”¨æˆ·id, è¿‡æœŸæ—¶é—´)` å•ä½æ˜¯æ¯«ç§’
- `StpUtil.logout()` æ³¨é”€å½“å‰ç”¨æˆ·
- `StpUtil.logout(è´¦å·id)` 
- `StpUtil.logout(è´¦å·idï¼Œç«¯)` æ³¨é”€ pc ç«¯ï¼Œè¿˜æ˜¯ â€¦â€¦
- `StpUtil.logoutByTokenValue(token)` æŒ‡å®š token æ³¨é”€
- ã€æŸ¥ã€‘
	- `boolean StpUtil.isLogin()` ç™»å½•çŠ¶æ€
	- `StpUtil.getLoginId()` è·å–å½“å‰ä¼šè¯è´¦å· idï¼Œè·å–ä¸åˆ°ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯è·å–åˆ°äº†ä¼šè‡ªåŠ¨æ›´æ–° active-timeout
	- `StpUtil.getLoginIdDefaultNull()` è·å–å½“å‰ä¼šè¯è´¦å· idï¼Œæœªç™»å½•è¿”å› null
	- `StpUtil.getLoginIdByToken(String tokenValue)` è·å–æŒ‡å®š token çš„è´¦å· idï¼Œæœªç™»å½•è¿”å› null

# â¤ï¸ token

> [!quote] token çš„çŠ¶æ€
> - è¿‡æœŸ ---> timeout åˆ°äº†
> - æ— æ•ˆ ---> æ‰‹åŠ¨æ³¨é”€ï¼Œè¸¢äººä¸‹çº¿
> - å†»ç»“ ---> active-timeout åˆ°äº†

> [!warning] ! ! !
> 1. è·¨åŸŸçš„æƒ…å†µä¸‹ï¼Œä¸å»ºè®®å‰ç«¯å¾€ header ä¸­å¡è‡ªå®šä¹‰çš„ tokenï¼Œå› ä¸ºä¼šè§¦å‘ OPTIONS é¢„æ£€è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚æ˜¯ä¸ä¼šæºå¸¦ token ä¿¡æ¯çš„ï¼Œæ­¤æ—¶åç«¯æ¥å—åˆ°åä¼šæŠ¥ token é”™è¯¯ï¼Œé¢„æ£€è¯·æ±‚æŠ¥é”™ï¼Œåˆ™å®é™…è¯·æ±‚å°±ä¼šæŠ¥è·¨åŸŸé”™è¯¯
> 2. æ¨èåç«¯çš„ç™»å½•æ¥å£ç›´æ¥å¾€å“åº”ç»“æœçš„å“åº”å¤´ä¸­æ”¾ Set-Cookieï¼Œè¿™æ ·æµè§ˆå™¨ä¼šè‡ªåŠ¨ç»™æ‰€æœ‰è¯·æ±‚åŠ ä¸Šè¯¥ Cookieï¼Œåç«¯å†è¿›è¡Œåˆ¤æ–­

- `StpUtil.getTokenValue()` è·å–å½“å‰ä¼šè¯çš„ token 
- `StpUtil.getTokenInfo()` æŸ¥è¯¢ token ä¿¡æ¯
- `StpUtil.getTokenName()` è·å–å½“å‰ `StpLogic` çš„ token åç§°
- `StpUtil.searchTokenValue(æœç´¢çš„å…³é”®è¯, åˆ†é¡µé¡µç , åˆ†é¡µå¤§å°, æ˜¯å¦å‡åºæ’åº)` æŸ¥æ‰¾æ‰€æœ‰å·²ç™»å½•çš„ token 
	- å…³é”®è¯ä¸éœ€è¦å¯ä»¥ä¼ ç©ºå­—ç¬¦ä¸²
	- å‡åº ï¼šå…ˆç™»å½•çš„åœ¨å‰

## ğŸ’› timeout

> [!quote] timeout æœ‰æ•ˆæœŸ
> timeout ä»£è¡¨ token çš„é•¿ä¹…æœ‰æ•ˆæœŸï¼Œ~~å•ä½/ç§’~~ï¼Œåœ¨ timeout å token å¿…å®šè¿‡æœŸï¼Œæ— æ³•ç»§ç»­ä½¿ç”¨
> 
> - timeout é…ç½®ä¸º `-1` ï¼Œä»£è¡¨æ°¸ä¹…æœ‰æ•ˆï¼Œä¸ä¼šè¿‡æœŸã€‚ä½¿ç”¨ `StpUtil.renewTimeout(100)` ç»­ç­¾
> - åˆ°æœŸå¿…é¡»é‡æ–°ç™»å½•

- `StpUtil.getTokenTimeout()` è·å–å½“å‰ä¼šè¯å‰©ä½™æœ‰æ•ˆæœŸï¼ˆ-1 ä¸ºæ°¸ä¹…æœ‰æ•ˆï¼‰ï¼Œ~~å•ä½ç§’~~

#é—®é¢˜ timeout è¿‡æœŸä¹‹åï¼Œtoken ä¼šè¢«åˆ é™¤å— ?

## ğŸ’› active-timeout

> [!quote] active-timeout æœ€ä½æ´»è·ƒé¢‘ç‡
> active-timeout ä»£è¡¨æœ€ä½æ´»è·ƒé¢‘ç‡ï¼Œ~~å•ä½/ç§’~~ï¼Œç”¨æˆ·åœ¨ active-timeout å†…æ— æ“ä½œï¼Œåˆ™æ­¤ token ç«‹å³è¿‡æœŸï¼Œä½†ä¸ä¼šè¢«åˆ é™¤
> 
> - ç”¨æˆ·åœ¨ active-timeout å†…æœ‰æ“ä½œï¼Œåˆ™ä¼šå†æ¬¡ç»­ç­¾
> - active-timeout é…ç½®ä¸º `-1` ï¼Œä»£è¡¨æ°¸ä¹…æœ‰æ•ˆï¼Œä¸ä¼šè¿‡æœŸ
> - **æ‰€ä»¥è°ƒç”¨è¿‡** `StpUtil.getLoginId()` **çš„æ–¹æ³•éƒ½ä¼šç»­ç­¾ active-timeout**ï¼Œ[å“ªäº›æ–¹æ³•æ³¨è§£ä¼šè‡ªåŠ¨ç»­ç­¾](https://sa-token.cc/doc.html#/fun/token-timeout?id=stputil-%e7%b1%bb%e4%b8%ad%e5%93%aa%e4%ba%9b%e5%85%ac%e5%bc%80%e6%96%b9%e6%b3%95%e6%94%af%e6%8c%81%e8%87%aa%e5%8a%a8%e7%bb%ad%e7%ad%be-active-timeout)

- `StpUtil.checkActiveTimeout()` æ£€æŸ¥å½“å‰ token æ˜¯å¦å·²ç»è¢«å†»ç»“ï¼Œå¦‚æœæ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸
- `StpUtil.updateLastActiveToNow()` ç»­ç­¾å½“å‰ tokenï¼Œ**å³ä½¿ token å·²ç»è¢«å†»ç»“ä¹Ÿå¯ç»­ç­¾æˆåŠŸ**
- `StpUtil.updateLastActiveToNow(token)` ä¸ºæŒ‡å®š token ç»­ç­¾ï¼Œ**å³ä½¿ token å·²ç»è¢«å†»ç»“ä¹Ÿå¯ç»­ç­¾æˆåŠŸ**

# â¤ï¸ é‰´æƒ
- ç»´æŠ¤ä¸€ä¸ªæƒé™ï¼Œå’Œè§’è‰²çš„é…ç½®
```java
@Configuration
public class SaTokenPermissionConfig implements StpInterface {

    /**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„æƒé™ç é›†åˆ
     */
    @Override
    public List<String> getPermissionList(Object loginId, String loginType) {
        return List.of();
    }

    /**
     * è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„è§’è‰²é›†åˆ
     * @param loginId ç”¨æˆ·id
     * @param loginType è´¦å·ä½“ç³»æ ‡è¯†
     */
    @Override
    public List<String> getRoleList(Object loginId, String loginType) {
        Map<String, List<String>> roleMap = MapBuilder.create(new HashMap<String, List<String>>())
                .put("10001", List.of("admin"))
                .put("10002", List.of("user"))
                .put("10003", List.of("guest"))
                .build();

        return roleMap.get(loginId.toString());
    }
}
```

## ğŸ’› ä»£ç é‰´æƒ - ä¸æ¨è
### ğŸ’™ è§’è‰²
- `StpUtil.getRoleList()` è·å–å½“å‰è´¦å·æ‰€æ‹¥æœ‰çš„è§’è‰²é›†åˆ
- `StpUtil.hasRole(è§’è‰²å)` åˆ¤æ–­å½“å‰è´¦å·æ˜¯å¦æ‹¥æœ‰æŒ‡å®šè§’è‰²
- `StpUtil.checkRole(è§’è‰²å)` 
- `StpUtil.checkRoleAnd(è§’è‰²æ•°ç»„)` æ ¡éªŒå½“å‰è´¦å·æ˜¯å¦å«æœ‰æŒ‡å®šè§’è‰²æ ‡è¯†ï¼Œå…¨éƒ¨é€šè¿‡æ‰è¡Œ
- `StpUtil.checkRoleOr(è§’è‰²æ•°ç»„)` æ ¡éªŒå½“å‰è´¦å·æ˜¯å¦å«æœ‰æŒ‡å®šè§’è‰²æ ‡è¯†ï¼Œå…¶ä¸€é€šè¿‡å³å¯

### ğŸ’™ æƒé™ 

## ğŸ’› æ³¨è§£é‰´æƒ - ä¸æ¨è
åœ¨ Controller å±‚åŠ å…¥æ³¨è§£åˆ¤æ–­æ˜¯å¦æœ‰æƒé™è¿›å…¥

### ğŸ’™ è®¤è¯å¿½ç•¥
- `@SaIgnore` è¢«å…¶ä¿®é¥°çš„æ‰€æœ‰æ–¹æ³•å’Œç±»ï¼Œéƒ½æ— éœ€è®¤è¯å³å¯è®¿é—®ï¼Œ**æ­¤æ³¨è§£å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§**

## ğŸ’› è·¯ç”±æ‹¦æˆªé‰´æƒ - æ¨è
å¯¹æ‰€æœ‰çš„æ¥å£è¿›è¡Œç»Ÿä¸€ç®¡ç†

```java
@Configuration
public class STPRouteInterceptor implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new SaInterceptor(handler -> {
                    // å·²ç»è¢«æ‹¦æˆªå™¨æ‹¦æˆªåˆ°äº†ï¼Œæ¥ä¸‹æ¥è¦æ€ä¹ˆå¤„ç†
                    SaRouter.match("/api/raffle/**", "/api/security/**")
                            .notMatch("/api/security/user/v1/doLogin")
                            .notMatch(SaHttpMethod.OPTIONS)  // æ”¾è¡Œé¢„æ£€è¯·æ±‚
                            .check(() -> StpUtil.checkRoleOr(EnumSet
                                    .allOf(UserBO.UserRole.class).stream()
                                    .map(Enum::name)
                                    .toArray(String[]::new)
                            ));
                }))
                .addPathPatterns("/api/**");  // æŒ‡å®šæ‹¦æˆªå™¨éœ€è¦æ‹¦æˆªçš„ URL
    }

}
```

#é—®é¢˜ 
```java
SaRouter.match("/api/raffle/**", "/api/security/**")
		.notMatch("/api/security/user/v1/doLogin")
		.check(() -> StpUtil.checkRoleOr(EnumSet
				.allOf(UserBO.UserRole.class).stream()
				.map(Enum::name)
				.toArray(String[]::new)
		));
ä¸
SaRouter.match("/api/raffle/**")
		.match("/api/security/**")
		.notMatch("/api/security/user/v1/doLogin")
		.check(() -> StpUtil.checkRoleOr(EnumSet
				.allOf(UserBO.UserRole.class).stream()
				.map(Enum::name)
				.toArray(String[]::new)
		));
æ˜¯ä¸ä¸€æ ·çš„
```







